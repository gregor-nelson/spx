# Handover Prompt for Next Claude Code Session

Copy and paste this entire prompt to start the next session:

---

## Context

I'm building an SPX OTM put volume anomaly detection system to monitor for unusual institutional hedging activity. This is an early-warning system for potential market stress events.

**Current Status:** Frontend is complete with enriched data visualization. Backend needs robustness improvements - specifically consolidating poller and EOD into a unified, long-running script with smart scheduling.

## Important Instructions

**Before writing code:**
1. Read the documentation files listed below
2. Discuss your proposed architecture with me
3. Ask clarifying questions about requirements

I prefer thoughtful, well-considered solutions. Simple and maintainable over complex.

## Files to Read First

1. `Docs/SESSION_SUMMARY_20251204_V2.md` - Most recent session (enriched API + frontend)
2. `spx_poller.py` - Current polling + detection implementation
3. `spx_eod.py` - Current EOD consolidation script
4. `server.py` - Flask API server with enriched endpoint
5. `Database/spx_database.py` - Database module

## What's Been Built

### Data Collection (Current - Needs Improvement)
- `spx_poller.py` - Polling script (run manually or via cron)
- `spx_eod.py` - EOD consolidation (separate script, run manually)
- SQLite database with intraday_snapshots, daily_history, alerts tables

### Anomaly Detection (integrated into poller)
- Time-aligned day-over-day volume comparison
- Three flag types: delta, multiplier, dormancy
- Configurable thresholds at top of script

### Web Dashboard (Complete)
- `server.py` - Flask API with enriched endpoint
- `index.html` - Plotly charts, Top Movers, color-coded visualizations
- Dark theme, auto-refresh, expiration filtering

### Current Architecture Problem
```
Current (fragile):
┌─────────────┐     ┌─────────────┐
│ spx_poller  │     │  spx_eod    │
│  (manual)   │     │  (manual)   │
└─────────────┘     └─────────────┘
       ↓                   ↓
   Cron needed         Cron needed
   (hourly)            (after close)
```

## Priority Task: Unified Scheduler

### Goal
Create a single long-running script that:
1. Polls at configurable intervals during market hours
2. Automatically runs EOD consolidation at market close
3. Handles weekends/holidays gracefully
4. Can run continuously without cron

### Proposed Architecture
```
Desired:
┌─────────────────────────────────────┐
│         spx_scheduler.py            │
│  ┌─────────────────────────────┐    │
│  │ Configuration (top of file) │    │
│  │ - POLL_INTERVAL_MINUTES: 30 │    │
│  │ - MARKET_OPEN_ET: "09:30"   │    │
│  │ - MARKET_CLOSE_ET: "16:00"  │    │
│  │ - EOD_DELAY_MINUTES: 15     │    │
│  └─────────────────────────────┘    │
│                                     │
│  Main Loop:                         │
│  1. Check if market is open         │
│  2. If open → poll at interval      │
│  3. If just closed → run EOD        │
│  4. If closed → sleep until open    │
│  5. Handle weekends/holidays        │
└─────────────────────────────────────┘
```

### Configuration Requirements

All timing parameters should be constants at the top of the script:

```python
# =============================================================================
# SCHEDULER CONFIGURATION
# =============================================================================

# Polling
POLL_INTERVAL_MINUTES = 30       # How often to poll during market hours (15-60)
POLL_START_DELAY_MINUTES = 15    # Minutes after open to start first poll

# Market Hours (Eastern Time)
MARKET_OPEN_ET = "09:30"
MARKET_CLOSE_ET = "16:00"
TIMEZONE = "America/New_York"

# EOD Processing
EOD_DELAY_MINUTES = 15           # Minutes after close to run EOD
EOD_CONSOLIDATION_ENABLED = True

# Retry/Recovery
MAX_POLL_RETRIES = 3
RETRY_DELAY_SECONDS = 60

# Logging
LOG_LEVEL = "INFO"
LOG_TO_FILE = True
LOG_FILE_PATH = "logs/scheduler.log"
```

### Market Hours Logic

The script needs to:
1. Know current time in ET (handle daylight saving)
2. Detect if today is a trading day (skip weekends)
3. Detect market holidays (optional - could be simple list or API)
4. Calculate time until next action (open, next poll, close)

### State Machine

```
States:
- WAITING_FOR_OPEN    : Before 9:30 ET on trading day
- MARKET_OPEN         : Between 9:30-16:00 ET, polling active
- EOD_PENDING         : Market just closed, waiting for EOD delay
- EOD_RUNNING         : Running consolidation
- MARKET_CLOSED       : After EOD complete, waiting for next day
- WEEKEND             : Saturday/Sunday, sleeping
```

### Robustness Improvements (from previous session)

Also integrate these improvements into the new script:

1. **Fallback comparison logic**: If same-hour yesterday data doesn't exist, fall back to most recent yesterday poll

2. **Data availability tracking**: Track and log what comparison data is available

3. **Graceful error handling**: Continue running even if individual polls fail

4. **Status reporting**: Log clear status messages about what the script is doing

### Console Output Example

```
======================================================================
SPX Options Scheduler
======================================================================
[2025-12-04 09:15:00 ET] Starting scheduler
  Poll interval: 30 minutes
  Market hours: 09:30 - 16:00 ET

[2025-12-04 09:15:00 ET] State: WAITING_FOR_OPEN
  Next action: First poll at 09:45 ET (in 30 minutes)

[2025-12-04 09:45:00 ET] State: MARKET_OPEN
  Running poll #1 of the day...
  [POLL] Found 2 expirations, 146 contracts
  [POLL] Stored 146 snapshots
  [DETECTION] 3 anomalies detected
  Next poll at 10:15 ET

[2025-12-04 10:15:00 ET] State: MARKET_OPEN
  Running poll #2...
  ...

[2025-12-04 16:00:00 ET] State: EOD_PENDING
  Market closed. EOD consolidation in 15 minutes...

[2025-12-04 16:15:00 ET] State: EOD_RUNNING
  Running EOD consolidation...
  [EOD] Consolidated 146 contracts to daily_history
  [EOD] Cleaned up 0 old intraday records

[2025-12-04 16:15:30 ET] State: MARKET_CLOSED
  Next trading day: 2025-12-05
  Sleeping until 09:15 ET tomorrow...
```

## Questions for Discussion

Before implementing, let's discuss:

1. **Holidays**: How to handle market holidays?
   - Hard-coded list for current year?
   - Simple approach: just skip if no data returned?
   - External API/calendar?

2. **Timezone handling**: Best Python approach for ET with DST?
   - `pytz` library?
   - `zoneinfo` (Python 3.9+)?

3. **Long-running stability**:
   - Memory management considerations?
   - Watchdog/auto-restart on crash?
   - Health check endpoint?

4. **Existing scripts**:
   - Keep `spx_poller.py` and `spx_eod.py` for manual runs?
   - Or fully replace with new scheduler?

5. **Notification integration**:
   - Should scheduler also handle notifications?
   - Or keep that separate for later?

## Technical Notes

### Current Thresholds (in spx_poller.py)
```python
VOLUME_FLOOR = 100              # Minimum volume to consider
PREMIUM_FLOOR = 100_000         # Minimum notional ($)
DELTA_THRESHOLD = 200           # Flag if volume delta exceeds
DORMANCY_THRESHOLD = 100        # Flag if was 0 yesterday, now exceeds
MULTIPLIER_THRESHOLD = 100      # Flag if today > N× yesterday
```

### Environment
- Windows development, Linux VPS production
- Python 3.x, Flask, SQLite
- API: Polygon.io (Massive) - 15-min delayed data

### Running Current System
```bash
# Start dashboard
python server.py
# Open http://localhost:5000

# Run poller manually
python spx_poller.py

# EOD consolidation
python spx_eod.py
```

## Deferred Items (Not for This Session)

- Weekly expiration support
- Percentile-based scoring (needs more data)
- Mobile notifications (Pushover)
- Frontend enhancements (complete for now)

## Start Here

Please begin by:
1. Reading the files listed above
2. Understanding the current poller and EOD logic
3. Proposing your architecture for the unified scheduler
4. Asking any clarifying questions

Do NOT start coding until we've discussed the approach.

---

**End of Handover Prompt**
