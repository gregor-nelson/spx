# Handover Prompt for Next Claude Code Session

Copy and paste this entire prompt to start the next session:

---

## Context

I'm building an SPX OTM put volume anomaly detection system to monitor for unusual institutional hedging activity. This is an early-warning system for potential market stress events.

**Current Status:** Multi-expiration polling works (monthlies only). Plotly-based frontend with charts and filtering is functional. Now focusing on notifications and frontend polish.

## Important Instructions

**Before writing code:**
1. Read the documentation files listed below
2. Discuss approach with me for significant changes
3. Ask clarifying questions about requirements

I prefer thoughtful, well-considered solutions. Simple and maintainable over complex.

## Files to Read First

1. `SESSION_SUMMARY_20251204.md` - Most recent session (multi-expiration + Plotly)
2. `spx_poller.py` - Current polling + detection implementation
3. `server.py` - Flask API server
4. `index.html` - Current frontend with Plotly charts
5. `Database/spx_database.py` - Database module

## What's Been Built

### Data Collection
- `spx_poller.py` - Hourly polling (80-95% moneyness, 3-45 DTE, multiple monthly expirations)
- `spx_eod.py` - End-of-day consolidation
- SQLite database with intraday_snapshots, daily_history, alerts tables

### Anomaly Detection (integrated into poller)
- Time-aligned day-over-day volume comparison
- Three flag types: delta, multiplier, dormancy
- Configurable thresholds at top of script
- Console logging (database storage toggleable via `ALERT_STORAGE_ENABLED`)

### Web Dashboard
- `server.py` - Flask API with expiration filtering
- `index.html` - Plotly charts + tabular views
- Dark theme, auto-refresh every 60 seconds
- Expiration dropdown filter

### Current Charts (Plotly)
1. Volume by Strike (bar chart)
2. Open Interest by Strike (bar chart)
3. Volume Heatmap (strike × expiration grid)
4. Volume Over Time (line chart)

## Priority Tasks for This Session

### 1. Mobile Notifications (HIGH PRIORITY)

**Current state:** Alerts detected and logged to console. Storage to database toggleable but not connected to notifications.

**Goal:** Push alerts to mobile device via Pushover or Telegram when anomalies are detected.

**Architecture:**
- New module: `notifier.py`
- Called from `spx_poller.py` after alerts are generated
- Should be toggleable and rate-limited (don't spam on first run)
- Consider storing delivery status in alerts table

**Implementation considerations:**
- Pushover: $5 one-time, simple API, good for personal use
- Telegram: Free, requires bot setup, slightly more complex
- Either works - I'm open to recommendation

**Notification content should include:**
- Strike, expiration, DTE
- Current volume vs yesterday
- Notional value
- Flag types triggered

### 2. Frontend Visual Improvements (HIGH PRIORITY)

**Goal:** Make the dashboard maximally informative and easy to quickly scan for volume changes.

**Current issues to address:**
- Charts may not clearly highlight significant changes
- Need better visual hierarchy
- Volume changes should "pop" visually
- Ensure data accuracy in all visualizations

**Specific improvements to consider:**

**a) Volume Change Highlighting:**
- Color-code bars by volume delta (green for increases)
- Add annotations for significant spikes
- Consider adding a "top movers" summary

**b) Heatmap Improvements:**
- Better color scale for volume intensity
- Add OI heatmap option
- Consider log scale for better distribution

**c) New Visualizations:**
- Notional value by strike (premium × volume × 100)
- Volume delta chart (changes since last poll)
- Day-over-day comparison view

**d) Layout/UX:**
- Key metrics at top (total volume, total notional, largest move)
- Sortable tables
- Click-to-filter from charts
- Mobile responsiveness check

**e) Data Accuracy:**
- Verify volume numbers match between charts and tables
- Ensure heatmap correctly aggregates across expirations
- Check time series aggregation logic

### 3. Alert Display Enhancement (MEDIUM PRIORITY)

**Current state:** Alerts shown in basic table.

**Goals:**
- Visual alert cards instead of table rows
- Show alert context (what's unusual about this)
- Historical comparison view
- Acknowledgement UI

## Technical Notes

### API Endpoints
- Option Chain: `GET /v3/snapshot/options/SPX` - Discovery
- Unified Snapshot: `GET /v3/snapshot?ticker.any_of=...` - Details with greeks

### Current Thresholds
```python
VOLUME_FLOOR = 100              # Minimum volume to consider
PREMIUM_FLOOR = 100_000         # Minimum notional ($)
DELTA_THRESHOLD = 200           # Flag if volume delta exceeds
DORMANCY_THRESHOLD = 100        # Flag if was 0 yesterday, now exceeds
MULTIPLIER_THRESHOLD = 5        # Flag if today > N× yesterday
```

### Environment
- Windows development, Linux VPS production
- Python 3.x, Flask, SQLite
- API: Polygon.io (Massive) - 15-min delayed data
- Frontend: Plotly.js via CDN

### Running the System
```bash
# Start dashboard
python server.py
# Open http://localhost:5000

# Run poller manually
python spx_poller.py

# EOD consolidation
python spx_eod.py
```

## Questions for Discussion

1. **Notification service:** Pushover ($5) or Telegram (free)? I'm leaning toward Pushover for simplicity.

2. **Alert rate limiting:** How to handle first-run scenario where all contracts trigger "dormancy"? Ideas:
   - Skip notifications if >10 alerts in single poll
   - Only notify on multiplier/delta flags (not dormancy alone)
   - Require minimum score threshold

3. **Frontend priority:** Which visual improvements would be most valuable?
   - Volume delta highlighting
   - Notional value charts
   - Top movers summary
   - Something else?

4. **Chart accuracy:** Any specific concerns about data display I should verify?

## Deferred Items (Not for This Session)

- Weekly expiration support (code structure ready, just not enabled)
- Percentile-based scoring (needs more data accumulation)
- Backtesting framework
- OI surge detection

## Start Here

Please begin by reading the files listed above, then let's discuss:
1. Your recommendation for notification service
2. Most impactful frontend improvements to tackle first
3. Any data accuracy concerns you notice in the current implementation

---

**End of Handover Prompt**
