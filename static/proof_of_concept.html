<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRACE 3D - Options Flow Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-gl@2.0.9/dist/echarts-gl.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0b0e14;
            --bg-secondary: #121820;
            --bg-tertiary: #1a2332;
            --bg-elevated: #232d3f;
            --border: #2a3544;
            --border-bright: #3d4f66;
            --text: #e6edf5;
            --text-secondary: #8b9eb3;
            --text-muted: #5a6b7d;
            
            /* Trading Colors */
            --positive: #00d4aa;
            --positive-dim: rgba(0, 212, 170, 0.15);
            --positive-mid: rgba(0, 212, 170, 0.4);
            --negative: #ff4757;
            --negative-dim: rgba(255, 71, 87, 0.15);
            --negative-mid: rgba(255, 71, 87, 0.4);
            --neutral: #ffa502;
            --neutral-dim: rgba(255, 165, 2, 0.15);
            --hiro: #a855f7;
            --hiro-dim: rgba(168, 85, 247, 0.3);
            
            /* Accent */
            --accent: #3b82f6;
            --accent-dim: rgba(59, 130, 246, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Sans', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }

        /* Main Layout */
        .app {
            display: grid;
            grid-template-rows: 56px 1fr 80px;
            grid-template-columns: 260px 1fr 200px;
            height: 100vh;
            gap: 1px;
            background: var(--border);
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-right: 24px;
            border-right: 1px solid var(--border);
        }

        .logo-mark {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--positive) 0%, var(--accent) 100%);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 700;
            font-size: 14px;
            color: var(--bg-primary);
        }

        .logo-text {
            font-weight: 700;
            font-size: 18px;
            letter-spacing: -0.5px;
        }

        .logo-text span {
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Ticker Display */
        .ticker {
            display: flex;
            align-items: baseline;
            gap: 12px;
        }

        .ticker-symbol {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .ticker-price {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 22px;
            font-weight: 600;
        }

        .ticker-change {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .ticker-change.up {
            background: var(--positive-dim);
            color: var(--positive);
        }

        .ticker-change.down {
            background: var(--negative-dim);
            color: var(--negative);
        }

        /* Stability Gauge */
        .stability-gauge {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-left: auto;
        }

        .stability-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .stability-bar {
            width: 100px;
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 3px;
            overflow: hidden;
        }

        .stability-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease, background 0.5s ease;
        }

        .stability-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            min-width: 36px;
        }

        /* Gamma Environment Badge */
        .gamma-env {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .gamma-env.positive {
            background: var(--positive-dim);
            color: var(--positive);
            border: 1px solid var(--positive-mid);
        }

        .gamma-env.negative {
            background: var(--negative-dim);
            color: var(--negative);
            border: 1px solid var(--negative-mid);
        }

        .gamma-env-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Header Stats */
        .header-stats {
            display: flex;
            gap: 20px;
        }

        .header-stat {
            text-align: center;
        }

        .header-stat-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .header-stat-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 14px;
            font-weight: 600;
        }

        /* Strike Plot Panel */
        .strike-panel {
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        /* Strike Plot Toggles */
        .strike-toggles {
            display: flex;
            gap: 4px;
        }

        .strike-toggle {
            padding: 4px 10px;
            font-size: 10px;
            font-weight: 600;
            font-family: inherit;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .strike-toggle:hover {
            border-color: var(--border-bright);
            color: var(--text-secondary);
        }

        .strike-toggle.active {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* 0DTE Toggle */
        .odte-toggle {
            padding: 8px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 36px;
            height: 20px;
            background: var(--bg-elevated);
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .toggle-switch.active {
            background: var(--accent);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--text);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
        }

        .toggle-switch.active::after {
            transform: translateX(16px);
        }

        .toggle-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .toggle-label span {
            color: var(--neutral);
            font-weight: 600;
        }

        /* Strike Chart Container */
        #strikeChart {
            flex: 1;
            min-height: 0;
        }

        /* Key Levels List */
        .key-levels {
            padding: 12px;
            border-top: 1px solid var(--border);
        }

        .key-levels-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .key-level {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 8px;
            margin-bottom: 4px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            border-left: 3px solid transparent;
        }

        .key-level.max-gamma { border-left-color: var(--neutral); }
        .key-level.gamma-flip { border-left-color: var(--hiro); }
        .key-level.call-wall { border-left-color: var(--positive); }
        .key-level.put-wall { border-left-color: var(--negative); }

        .key-level-name {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .key-level-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            font-weight: 600;
        }

        /* Main 3D View */
        .main-view {
            background: var(--bg-primary);
            position: relative;
            overflow: hidden;
        }

        #chart3d {
            width: 100%;
            height: 100%;
        }

        /* Lens Selector */
        .lens-selector {
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 100;
            display: flex;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .lens-btn {
            padding: 10px 18px;
            font-size: 12px;
            font-weight: 600;
            font-family: inherit;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s ease;
            border-right: 1px solid var(--border);
        }

        .lens-btn:last-child {
            border-right: none;
        }

        .lens-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .lens-btn.active {
            background: var(--accent-dim);
            color: var(--accent);
        }

        /* Camera Controls */
        .camera-controls {
            position: absolute;
            top: 16px;
            right: 220px;
            z-index: 100;
            display: flex;
            gap: 6px;
        }

        .camera-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 11px;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
        }

        .camera-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-bright);
            color: var(--text);
        }

        .camera-btn.active {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* View Options */
        .view-options {
            position: absolute;
            bottom: 16px;
            left: 16px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .view-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(18, 24, 32, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .view-option:hover {
            border-color: var(--border-bright);
        }

        .view-option input {
            display: none;
        }

        .view-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-bright);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .view-option input:checked + .view-checkbox {
            background: var(--accent);
            border-color: var(--accent);
        }

        .view-checkbox svg {
            width: 10px;
            height: 10px;
            stroke: var(--bg-primary);
            stroke-width: 3;
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .view-option input:checked + .view-checkbox svg {
            opacity: 1;
        }

        .view-option-label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Interpretation Panel */
        .interpretation {
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .interpretation-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .interpretation-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        /* Color Scale */
        .color-scale {
            padding: 16px;
            flex: 1;
        }

        .scale-gradient {
            height: 200px;
            width: 24px;
            border-radius: 4px;
            margin: 0 auto 12px;
        }

        .scale-labels {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .scale-label {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .scale-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .scale-text {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .scale-meaning {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Interpretation Guide */
        .interpretation-guide {
            padding: 16px;
            border-top: 1px solid var(--border);
        }

        .guide-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .guide-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            margin-bottom: 6px;
        }

        .guide-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .guide-icon.support {
            background: var(--positive-dim);
            color: var(--positive);
        }

        .guide-icon.resistance {
            background: var(--negative-dim);
            color: var(--negative);
        }

        .guide-text {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Bottom Bar */
        .bottom-bar {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            display: grid;
            grid-template-columns: 200px 1fr 200px;
            gap: 16px;
            padding: 12px 16px;
            align-items: center;
        }

        /* Playback Controls */
        .playback-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            box-shadow: 0 0 20px var(--accent-dim);
        }

        .play-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px var(--accent-dim);
        }

        .play-btn svg {
            width: 16px;
            height: 16px;
            fill: white;
        }

        .speed-controls {
            display: flex;
            gap: 4px;
        }

        .speed-btn {
            padding: 6px 10px;
            font-size: 11px;
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 500;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-muted);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .speed-btn:hover, .speed-btn.active {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Time Scrubber */
        .time-scrubber {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .time-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-muted);
        }

        .scrubber-container {
            position: relative;
            height: 40px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
        }

        #scrubberMini {
            position: absolute;
            inset: 0;
            opacity: 0.5;
        }

        .scrubber-progress {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            background: var(--accent-dim);
            pointer-events: none;
        }

        .scrubber-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--accent);
            pointer-events: none;
        }

        .scrubber-handle::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -5px;
            width: 12px;
            height: 6px;
            background: var(--accent);
            border-radius: 3px 3px 0 0;
        }

        /* HIRO Mini Chart */
        .hiro-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .hiro-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hiro-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .hiro-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 16px;
            font-weight: 600;
            color: var(--hiro);
        }

        #hiroMini {
            width: 180px;
            height: 36px;
        }

        /* Current Time Display */
        .current-time {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 100px;
            background: rgba(18, 24, 32, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 8px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            z-index: 100;
        }

        /* Tooltip */
        .custom-tooltip {
            position: absolute;
            pointer-events: none;
            z-index: 1000;
            background: rgba(18, 24, 32, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            min-width: 200px;
            display: none;
        }

        .tooltip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 8px;
        }

        .tooltip-strike {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 16px;
            font-weight: 600;
        }

        .tooltip-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin: 4px 0;
        }

        .tooltip-label {
            color: var(--text-muted);
        }

        .tooltip-value {
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 600;
        }

        .tooltip-value.positive { color: var(--positive); }
        .tooltip-value.negative { color: var(--negative); }

        .tooltip-percentile {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid var(--border);
        }

        /* Loading */
        .loading {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 16px;
            font-size: 13px;
            color: var(--text-muted);
            letter-spacing: 1px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Initializing TRACE</div>
    </div>

    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-mark">T</div>
                <div class="logo-text">TRACE <span>3D</span></div>
            </div>

            <div class="ticker">
                <span class="ticker-symbol">SPX</span>
                <span class="ticker-price" id="tickerPrice">5,872.16</span>
                <span class="ticker-change up" id="tickerChange">+18.42 (+0.31%)</span>
            </div>

            <div class="stability-gauge">
                <span class="stability-label">Stability</span>
                <div class="stability-bar">
                    <div class="stability-fill" id="stabilityFill" style="width: 72%; background: var(--positive);"></div>
                </div>
                <span class="stability-value" id="stabilityValue" style="color: var(--positive);">72%</span>
            </div>

            <div class="gamma-env positive" id="gammaEnv">
                <div class="gamma-env-dot"></div>
                <span>Positive Gamma</span>
            </div>

            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-label">Net GEX</div>
                    <div class="header-stat-value" id="netGex" style="color: var(--positive);">+$2.8B</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-label">0DTE %</div>
                    <div class="header-stat-value" id="odtePercent">34%</div>
                </div>
            </div>
        </header>

        <!-- Strike Plot Panel -->
        <aside class="strike-panel">
            <div class="panel-header">
                <span class="panel-title">Strike Plot</span>
                <div class="strike-toggles">
                    <button class="strike-toggle active" data-mode="gex">GEX</button>
                    <button class="strike-toggle" data-mode="oi">OI</button>
                    <button class="strike-toggle" data-mode="netoi">Net</button>
                </div>
            </div>

            <div class="odte-toggle">
                <div class="toggle-switch" id="odteSwitch"></div>
                <span class="toggle-label">Show <span>0DTE</span> Only</span>
            </div>

            <div id="strikeChart"></div>

            <div class="key-levels">
                <div class="key-levels-title">Key Levels</div>
                <div class="key-level max-gamma">
                    <span class="key-level-name">Max Gamma</span>
                    <span class="key-level-value" style="color: var(--neutral);" id="lvlMaxGamma">5875</span>
                </div>
                <div class="key-level gamma-flip">
                    <span class="key-level-name">Gamma Flip</span>
                    <span class="key-level-value" style="color: var(--hiro);" id="lvlGammaFlip">5850</span>
                </div>
                <div class="key-level call-wall">
                    <span class="key-level-name">Call Wall</span>
                    <span class="key-level-value" style="color: var(--positive);" id="lvlCallWall">5900</span>
                </div>
                <div class="key-level put-wall">
                    <span class="key-level-name">Put Wall</span>
                    <span class="key-level-value" style="color: var(--negative);" id="lvlPutWall">5800</span>
                </div>
            </div>
        </aside>

        <!-- Main 3D View -->
        <main class="main-view">
            <div id="chart3d"></div>

            <!-- Lens Selector -->
            <div class="lens-selector">
                <button class="lens-btn active" data-lens="gamma">Gamma</button>
                <button class="lens-btn" data-lens="delta">Delta Pressure</button>
                <button class="lens-btn" data-lens="charm">Charm Pressure</button>
            </div>

            <!-- Camera Controls -->
            <div class="camera-controls">
                <button class="camera-btn active" data-view="3d" title="3D View">3D</button>
                <button class="camera-btn" data-view="top" title="Top Down">↓</button>
                <button class="camera-btn" data-view="front" title="Front View">→</button>
                <button class="camera-btn" data-view="side" title="Side View">↑</button>
            </div>

            <!-- View Options -->
            <div class="view-options">
                <label class="view-option">
                    <input type="checkbox" id="showContours" checked>
                    <span class="view-checkbox">
                        <svg viewBox="0 0 12 12"><polyline points="2,6 5,9 10,3" fill="none"/></svg>
                    </span>
                    <span class="view-option-label">Contour Lines</span>
                </label>
                <label class="view-option">
                    <input type="checkbox" id="showKeyLevels" checked>
                    <span class="view-checkbox">
                        <svg viewBox="0 0 12 12"><polyline points="2,6 5,9 10,3" fill="none"/></svg>
                    </span>
                    <span class="view-option-label">Key Levels</span>
                </label>
                <label class="view-option">
                    <input type="checkbox" id="showPricePath" checked>
                    <span class="view-checkbox">
                        <svg viewBox="0 0 12 12"><polyline points="2,6 5,9 10,3" fill="none"/></svg>
                    </span>
                    <span class="view-option-label">Price Path</span>
                </label>
            </div>

            <!-- Current Time Overlay -->
            <div class="current-time" id="currentTime">12:45 PM ET</div>

            <!-- Tooltip -->
            <div class="custom-tooltip" id="tooltip">
                <div class="tooltip-header">
                    <span class="tooltip-strike">5875</span>
                    <span class="tooltip-time">11:30 AM</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Gamma</span>
                    <span class="tooltip-value positive">+$245M</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Delta</span>
                    <span class="tooltip-value">-$12.4M</span>
                </div>
                <div class="tooltip-percentile">82nd percentile (90-day)</div>
            </div>
        </main>

        <!-- Interpretation Panel -->
        <aside class="interpretation">
            <div class="interpretation-header">
                <span class="interpretation-title" id="interpTitle">Gamma Lens</span>
            </div>

            <div class="color-scale">
                <div class="scale-gradient" id="scaleGradient"></div>
                <div class="scale-labels" id="scaleLabels">
                    <!-- Populated by JS based on lens -->
                </div>
            </div>

            <div class="interpretation-guide">
                <div class="guide-title">Trading Implications</div>
                <div id="guideContent">
                    <!-- Populated by JS based on lens -->
                </div>
            </div>
        </aside>

        <!-- Bottom Bar -->
        <footer class="bottom-bar">
            <div class="playback-controls">
                <button class="play-btn" id="playBtn">
                    <svg viewBox="0 0 24 24" id="playIcon">
                        <polygon points="5,3 19,12 5,21"/>
                    </svg>
                </button>
                <div class="speed-controls">
                    <button class="speed-btn" data-speed="0.5">0.5×</button>
                    <button class="speed-btn active" data-speed="1">1×</button>
                    <button class="speed-btn" data-speed="2">2×</button>
                    <button class="speed-btn" data-speed="5">5×</button>
                </div>
            </div>

            <div class="time-scrubber">
                <div class="time-labels">
                    <span>9:30 AM</span>
                    <span>11:00</span>
                    <span>12:30 PM</span>
                    <span>2:00</span>
                    <span>4:00 PM</span>
                </div>
                <div class="scrubber-container" id="scrubberContainer">
                    <canvas id="scrubberMini"></canvas>
                    <div class="scrubber-progress" id="scrubberProgress"></div>
                    <div class="scrubber-handle" id="scrubberHandle"></div>
                </div>
            </div>

            <div class="hiro-section">
                <div class="hiro-header">
                    <span class="hiro-label">HIRO</span>
                    <span class="hiro-value" id="hiroValue">+$847M</span>
                </div>
                <div id="hiroMini"></div>
            </div>
        </footer>
    </div>

    <script>
        // =====================================================
        // TRACE 3D - Options Flow Visualization
        // =====================================================

        const CONFIG = {
            strikes: { min: 5800, max: 5950, step: 5 },
            times: 39, // 10-min intervals 9:30-16:00
            keyLevels: {
                maxGamma: 5875,
                gammaFlip: 5850,
                callWall: 5900,
                putWall: 5800
            },
            colors: {
                positive: '#00d4aa',
                negative: '#ff4757',
                neutral: '#ffa502',
                hiro: '#a855f7',
                accent: '#3b82f6'
            }
        };

        // State
        const state = {
            currentLens: 'gamma',
            currentTime: 20, // Mid-day
            isPlaying: false,
            playbackSpeed: 1,
            show0DTE: false,
            strikeMode: 'gex',
            showContours: true,
            showKeyLevels: true,
            showPricePath: true,
            gammaEnvironment: 'positive', // or 'negative'
            cameraView: '3d'
        };

        // Lens configurations
        const lensConfig = {
            gamma: {
                title: 'Gamma Lens',
                description: 'Anticipate volatility zones',
                gradient: ['#ff4757', '#ff6b7a', '#2a3544', '#00d4aa', '#00ffcc'],
                labels: [
                    { color: '#00d4aa', text: 'Blue Zones', meaning: 'Lower volatility, price tends to stabilize' },
                    { color: '#ff4757', text: 'Red Zones', meaning: 'Higher volatility, price moves quickly' },
                    { color: '#2a3544', text: 'Neutral', meaning: 'Transition zone, little hedging pressure' }
                ],
                guide: [
                    { type: 'support', text: 'Price tends to pin in blue zones at EOD' },
                    { type: 'resistance', text: 'Expect fast moves through red zones' }
                ]
            },
            delta: {
                title: 'Delta Pressure',
                description: 'Directional hedging flows',
                gradient: ['#ff4757', '#ff6b7a', '#2a3544', '#00d4aa', '#00ffcc'],
                labels: [
                    { color: '#00d4aa', text: 'Blue Zones', meaning: 'MM buying support (positive γ) or acceleration (negative γ)' },
                    { color: '#ff4757', text: 'Red Zones', meaning: 'MM selling resistance (positive γ) or acceleration (negative γ)' }
                ],
                guide: [
                    { type: 'support', text: 'Blue = buying pressure kicks in here' },
                    { type: 'resistance', text: 'Red = selling pressure kicks in here' }
                ]
            },
            charm: {
                title: 'Charm Pressure',
                description: 'Time decay hedging effects',
                gradient: ['#ff4757', '#ff6b7a', '#2a3544', '#00d4aa', '#00ffcc'],
                labels: [
                    { color: '#00d4aa', text: 'Blue Zones', meaning: 'Options decaying → MMs buy futures (support)' },
                    { color: '#ff4757', text: 'Red Zones', meaning: 'Options gaining → MMs sell futures (pressure)' }
                ],
                guide: [
                    { type: 'support', text: 'EOD pinning likely where red/blue meet' },
                    { type: 'resistance', text: 'Price moves through blue at EOD' }
                ]
            }
        };

        // Charts
        let chart3d, strikeChart, hiroChart;

        // =====================================================
        // Data Generation
        // =====================================================

        function generateSurfaceData(lens, timeSlice = null) {
            const data = [];
            const strikeCount = 30;
            const timeCount = timeSlice !== null ? 1 : CONFIG.times;
            const startTime = timeSlice !== null ? timeSlice : 0;

            for (let t = 0; t < timeCount; t++) {
                const time = startTime + t;
                for (let s = 0; s < strikeCount; s++) {
                    const strike = CONFIG.strikes.min + (s / strikeCount) * (CONFIG.strikes.max - CONFIG.strikes.min);
                    
                    let value;
                    const distFromFlip = strike - CONFIG.keyLevels.gammaFlip;
                    const distFromMax = strike - CONFIG.keyLevels.maxGamma;
                    
                    if (lens === 'gamma') {
                        // Gamma surface: positive above flip, negative below
                        const callGamma = Math.exp(-Math.pow(distFromMax, 2) / 1500) * 300;
                        const putGamma = -Math.exp(-Math.pow(distFromFlip + 30, 2) / 1000) * 200;
                        const timeDecay = 1 - (time / CONFIG.times) * 0.2;
                        const noise = Math.sin(time * 0.3 + s * 0.2) * 30;
                        value = (callGamma + putGamma) * timeDecay + noise;
                    } else if (lens === 'delta') {
                        // Delta pressure: directional hedging
                        const abovePrice = strike > 5870;
                        const base = abovePrice ? -150 : 150;
                        const gradient = distFromFlip * 2;
                        const timeEffect = Math.cos(time * 0.2) * 50;
                        value = base + gradient + timeEffect + (Math.random() - 0.5) * 40;
                    } else if (lens === 'charm') {
                        // Charm: time decay effects, strongest at EOD
                        const eodFactor = time / CONFIG.times;
                        const charmBase = distFromFlip > 0 ? -100 * eodFactor : 100 * eodFactor;
                        const oscillation = Math.sin((s + time) * 0.4) * 80 * eodFactor;
                        value = charmBase + oscillation;
                    }
                    
                    data.push([time, strike, value]);
                }
            }
            return data;
        }

        function generateStrikeData(mode) {
            const data = [];
            for (let strike = CONFIG.strikes.min; strike <= CONFIG.strikes.max; strike += 5) {
                const distFromMax = strike - CONFIG.keyLevels.maxGamma;
                
                if (mode === 'gex') {
                    const gex = Math.exp(-Math.pow(distFromMax, 2) / 1200) * 500 - 
                               Math.exp(-Math.pow(distFromMax + 40, 2) / 800) * 300;
                    data.push({ strike, value: gex + (Math.random() - 0.5) * 50 });
                } else if (mode === 'oi') {
                    const calls = Math.exp(-Math.pow(distFromMax - 20, 2) / 1500) * 8000;
                    const puts = Math.exp(-Math.pow(distFromMax + 20, 2) / 1500) * 6000;
                    data.push({ strike, calls: calls + Math.random() * 500, puts: puts + Math.random() * 400 });
                } else {
                    const netOI = (Math.random() - 0.5) * 3000 + distFromMax * 20;
                    data.push({ strike, value: netOI });
                }
            }
            return data;
        }

        function generatePricePath() {
            const path = [];
            let price = 5858;
            for (let t = 0; t <= state.currentTime; t++) {
                const drift = (CONFIG.keyLevels.gammaFlip - price) * 0.05;
                const noise = (Math.random() - 0.5) * 8;
                price += drift + noise;
                price = Math.max(CONFIG.strikes.min + 10, Math.min(CONFIG.strikes.max - 10, price));
                path.push({ time: t, price });
            }
            return path;
        }

        function generateHIROData() {
            const data = [];
            let hiro = 0;
            for (let t = 0; t < CONFIG.times; t++) {
                const flow = (Math.random() - 0.45) * 80 + Math.sin(t * 0.15) * 40;
                hiro += flow;
                data.push([t, hiro]);
            }
            return data;
        }

        // =====================================================
        // Chart Initialization
        // =====================================================

        function initCharts() {
            chart3d = echarts.init(document.getElementById('chart3d'));
            strikeChart = echarts.init(document.getElementById('strikeChart'));
            hiroChart = echarts.init(document.getElementById('hiroMini'));

            update3DChart();
            updateStrikeChart();
            updateHIROChart();
            updateInterpretation();
            drawScrubberMini();

            window.addEventListener('resize', () => {
                chart3d.resize();
                strikeChart.resize();
                hiroChart.resize();
            });
        }

        function update3DChart() {
            const surfaceData = generateSurfaceData(state.currentLens);
            const pricePath = generatePricePath();
            
            const priceLineData = pricePath.map(p => [p.time, p.price, 350]);
            
            // Key level planes data
            const keyLevelPlanes = state.showKeyLevels ? generateKeyLevelMarkers() : [];

            const option = {
                backgroundColor: 'transparent',
                visualMap: {
                    show: false,
                    dimension: 2,
                    min: -300,
                    max: 300,
                    inRange: {
                        color: lensConfig[state.currentLens].gradient
                    }
                },
                xAxis3D: {
                    type: 'value',
                    name: 'Time',
                    min: 0,
                    max: CONFIG.times,
                    axisLabel: {
                        formatter: (val) => formatTime(val),
                        color: '#5a6b7d',
                        fontSize: 10
                    },
                    axisLine: { lineStyle: { color: '#2a3544' } },
                    splitLine: { lineStyle: { color: '#1a2332', opacity: 0.5 } },
                    nameTextStyle: { color: '#5a6b7d', fontSize: 11 }
                },
                yAxis3D: {
                    type: 'value',
                    name: 'Strike',
                    min: CONFIG.strikes.min,
                    max: CONFIG.strikes.max,
                    axisLabel: { 
                        color: '#5a6b7d',
                        fontSize: 10
                    },
                    axisLine: { lineStyle: { color: '#2a3544' } },
                    splitLine: { lineStyle: { color: '#1a2332', opacity: 0.5 } },
                    nameTextStyle: { color: '#5a6b7d', fontSize: 11 }
                },
                zAxis3D: {
                    type: 'value',
                    name: getLensUnit(),
                    min: -400,
                    max: 400,
                    axisLabel: { 
                        color: '#5a6b7d',
                        fontSize: 10,
                        formatter: (val) => (val >= 0 ? '+' : '') + val
                    },
                    axisLine: { lineStyle: { color: '#2a3544' } },
                    splitLine: { lineStyle: { color: '#1a2332', opacity: 0.5 } },
                    nameTextStyle: { color: '#5a6b7d', fontSize: 11 }
                },
                grid3D: {
                    viewControl: getViewControl(),
                    boxWidth: 140,
                    boxHeight: 60,
                    boxDepth: 100,
                    light: {
                        main: {
                            intensity: 1.1,
                            shadow: true,
                            shadowQuality: 'high',
                            alpha: 40,
                            beta: 50
                        },
                        ambient: { intensity: 0.4 }
                    },
                    postEffect: {
                        enable: true,
                        bloom: { enable: true, intensity: 0.08 },
                        SSAO: { enable: true, radius: 3, intensity: 1 }
                    }
                },
                series: [
                    // Main surface
                    {
                        type: 'surface',
                        wireframe: {
                            show: state.showContours,
                            lineStyle: { color: 'rgba(255,255,255,0.06)', width: 0.5 }
                        },
                        itemStyle: { opacity: 0.92 },
                        shading: 'realistic',
                        realisticMaterial: { roughness: 0.6, metalness: 0.1 },
                        data: surfaceData
                    },
                    // Price path
                    state.showPricePath ? {
                        type: 'line3D',
                        data: priceLineData,
                        lineStyle: {
                            width: 5,
                            color: CONFIG.colors.neutral,
                            opacity: 0.95
                        }
                    } : null,
                    // Current price marker
                    state.showPricePath && pricePath.length > 0 ? {
                        type: 'scatter3D',
                        data: [[pricePath[pricePath.length - 1].time, pricePath[pricePath.length - 1].price, 350]],
                        symbolSize: 14,
                        symbol: 'diamond',
                        itemStyle: {
                            color: CONFIG.colors.neutral,
                            borderColor: '#fff',
                            borderWidth: 2
                        }
                    } : null,
                    // Key levels
                    ...keyLevelPlanes
                ].filter(Boolean)
            };

            chart3d.setOption(option, true);
        }

        function generateKeyLevelMarkers() {
            const markers = [];
            const levels = [
                { strike: CONFIG.keyLevels.maxGamma, color: CONFIG.colors.neutral, name: 'Max Gamma' },
                { strike: CONFIG.keyLevels.gammaFlip, color: CONFIG.colors.hiro, name: 'Gamma Flip' },
                { strike: CONFIG.keyLevels.callWall, color: CONFIG.colors.positive, name: 'Call Wall' },
                { strike: CONFIG.keyLevels.putWall, color: CONFIG.colors.negative, name: 'Put Wall' }
            ];

            levels.forEach(level => {
                markers.push({
                    type: 'scatter3D',
                    data: Array.from({ length: 10 }, (_, i) => [i * 4, level.strike, 380]),
                    symbolSize: 4,
                    itemStyle: { color: level.color, opacity: 0.7 }
                });
            });

            return markers;
        }

        function getViewControl() {
            const views = {
                '3d': { alpha: 25, beta: 45, distance: 200 },
                'top': { alpha: 90, beta: 0, distance: 220 },
                'front': { alpha: 0, beta: 0, distance: 220 },
                'side': { alpha: 0, beta: 90, distance: 220 }
            };
            return {
                ...views[state.cameraView],
                autoRotate: false,
                animation: true,
                animationDurationUpdate: 800
            };
        }

        function getLensUnit() {
            return state.currentLens === 'gamma' ? 'Gamma ($M)' : 
                   state.currentLens === 'delta' ? 'Delta ($M)' : 'Charm ($M)';
        }

        function updateStrikeChart() {
            const data = generateStrikeData(state.strikeMode);
            
            let series;
            if (state.strikeMode === 'oi') {
                series = [
                    {
                        type: 'bar',
                        data: data.map(d => ({ value: d.calls, itemStyle: { color: CONFIG.colors.neutral } })),
                        barWidth: '35%',
                        stack: 'oi'
                    },
                    {
                        type: 'bar',
                        data: data.map(d => ({ value: -d.puts, itemStyle: { color: CONFIG.colors.accent } })),
                        barWidth: '35%',
                        stack: 'oi'
                    }
                ];
            } else {
                series = [{
                    type: 'bar',
                    data: data.map(d => ({
                        value: d.value,
                        itemStyle: {
                            color: d.value >= 0 ? CONFIG.colors.positive : CONFIG.colors.negative
                        }
                    })),
                    barWidth: '60%'
                }];
            }

            const option = {
                backgroundColor: 'transparent',
                grid: {
                    left: 45,
                    right: 10,
                    top: 10,
                    bottom: 10
                },
                xAxis: {
                    type: 'value',
                    axisLine: { show: false },
                    axisTick: { show: false },
                    splitLine: { lineStyle: { color: '#1a2332' } },
                    axisLabel: { show: false }
                },
                yAxis: {
                    type: 'category',
                    data: data.map(d => d.strike),
                    axisLine: { lineStyle: { color: '#2a3544' } },
                    axisTick: { show: false },
                    axisLabel: {
                        color: '#5a6b7d',
                        fontSize: 9,
                        interval: 2
                    },
                    inverse: true
                },
                series: series,
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(18, 24, 32, 0.95)',
                    borderColor: '#2a3544',
                    textStyle: { color: '#e6edf5', fontSize: 11 }
                }
            };

            strikeChart.setOption(option);
        }

        function updateHIROChart() {
            const data = generateHIROData();
            const currentHiro = data[Math.min(state.currentTime, data.length - 1)][1];
            
            document.getElementById('hiroValue').textContent = 
                (currentHiro >= 0 ? '+' : '') + '$' + Math.abs(Math.round(currentHiro)) + 'M';

            const option = {
                backgroundColor: 'transparent',
                grid: { left: 0, right: 0, top: 2, bottom: 2 },
                xAxis: {
                    type: 'value',
                    show: false,
                    min: 0,
                    max: CONFIG.times
                },
                yAxis: {
                    type: 'value',
                    show: false
                },
                series: [{
                    type: 'line',
                    data: data.slice(0, state.currentTime + 1),
                    smooth: 0.3,
                    symbol: 'none',
                    lineStyle: { color: CONFIG.colors.hiro, width: 2 },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0, y: 0, x2: 0, y2: 1,
                            colorStops: [
                                { offset: 0, color: 'rgba(168, 85, 247, 0.3)' },
                                { offset: 1, color: 'rgba(168, 85, 247, 0)' }
                            ]
                        }
                    }
                }]
            };

            hiroChart.setOption(option);
        }

        function updateInterpretation() {
            const config = lensConfig[state.currentLens];
            
            document.getElementById('interpTitle').textContent = config.title;
            
            // Gradient
            const gradient = document.getElementById('scaleGradient');
            gradient.style.background = `linear-gradient(to bottom, ${config.gradient.slice().reverse().join(', ')})`;
            
            // Labels
            const labelsEl = document.getElementById('scaleLabels');
            labelsEl.innerHTML = config.labels.map(l => `
                <div class="scale-label">
                    <div class="scale-color" style="background: ${l.color}"></div>
                    <div>
                        <div class="scale-text">${l.text}</div>
                        <div class="scale-meaning">${l.meaning}</div>
                    </div>
                </div>
            `).join('');
            
            // Guide
            const guideEl = document.getElementById('guideContent');
            guideEl.innerHTML = config.guide.map(g => `
                <div class="guide-item">
                    <div class="guide-icon ${g.type}">${g.type === 'support' ? '↑' : '↓'}</div>
                    <div class="guide-text">${g.text}</div>
                </div>
            `).join('');
        }

        // =====================================================
        // Time & Playback
        // =====================================================

        function formatTime(timeIndex) {
            const minutes = 570 + timeIndex * 10;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            const period = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
            return `${displayHours}:${mins.toString().padStart(2, '0')}`;
        }

        function updateTimeDisplay() {
            const progress = state.currentTime / CONFIG.times;
            document.getElementById('scrubberProgress').style.width = (progress * 100) + '%';
            document.getElementById('scrubberHandle').style.left = (progress * 100) + '%';
            document.getElementById('currentTime').textContent = formatTime(state.currentTime) + ' ET';
        }

        let playbackInterval;

        function togglePlayback() {
            state.isPlaying = !state.isPlaying;
            const icon = document.getElementById('playIcon');
            
            if (state.isPlaying) {
                icon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
                startPlayback();
            } else {
                icon.innerHTML = '<polygon points="5,3 19,12 5,21"/>';
                stopPlayback();
            }
        }

        function startPlayback() {
            stopPlayback();
            playbackInterval = setInterval(() => {
                state.currentTime++;
                if (state.currentTime >= CONFIG.times) state.currentTime = 0;
                updateTimeDisplay();
                update3DChart();
                updateHIROChart();
            }, 1000 / state.playbackSpeed);
        }

        function stopPlayback() {
            if (playbackInterval) {
                clearInterval(playbackInterval);
                playbackInterval = null;
            }
        }

        function drawScrubberMini() {
            const canvas = document.getElementById('scrubberMini');
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            
            canvas.width = canvas.offsetWidth * dpr;
            canvas.height = canvas.offsetHeight * dpr;
            ctx.scale(dpr, dpr);
            
            const width = canvas.offsetWidth;
            const height = canvas.offsetHeight;
            
            for (let x = 0; x < width; x++) {
                const time = (x / width) * CONFIG.times;
                const intensity = Math.sin(time * 0.2) * 0.5 + 0.5;
                
                const gradient = ctx.createLinearGradient(0, 0, 0, height);
                if (intensity > 0.5) {
                    gradient.addColorStop(0, `rgba(0, 212, 170, ${intensity * 0.4})`);
                    gradient.addColorStop(1, 'transparent');
                } else {
                    gradient.addColorStop(0, `rgba(255, 71, 87, ${(1 - intensity) * 0.4})`);
                    gradient.addColorStop(1, 'transparent');
                }
                
                ctx.fillStyle = gradient;
                ctx.fillRect(x, 0, 1, height);
            }
        }

        // =====================================================
        // Event Handlers
        // =====================================================

        function initEventHandlers() {
            // Lens selector
            document.querySelectorAll('.lens-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.lens-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.currentLens = btn.dataset.lens;
                    update3DChart();
                    updateInterpretation();
                });
            });

            // Camera controls
            document.querySelectorAll('.camera-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.camera-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.cameraView = btn.dataset.view;
                    update3DChart();
                });
            });

            // Strike toggles
            document.querySelectorAll('.strike-toggle').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.strike-toggle').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.strikeMode = btn.dataset.mode;
                    updateStrikeChart();
                });
            });

            // 0DTE toggle
            document.getElementById('odteSwitch').addEventListener('click', function() {
                this.classList.toggle('active');
                state.show0DTE = this.classList.contains('active');
                updateStrikeChart();
            });

            // View options
            document.getElementById('showContours').addEventListener('change', (e) => {
                state.showContours = e.target.checked;
                update3DChart();
            });

            document.getElementById('showKeyLevels').addEventListener('change', (e) => {
                state.showKeyLevels = e.target.checked;
                update3DChart();
            });

            document.getElementById('showPricePath').addEventListener('change', (e) => {
                state.showPricePath = e.target.checked;
                update3DChart();
            });

            // Playback
            document.getElementById('playBtn').addEventListener('click', togglePlayback);

            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.playbackSpeed = parseFloat(btn.dataset.speed);
                    if (state.isPlaying) startPlayback();
                });
            });

            // Scrubber
            const scrubber = document.getElementById('scrubberContainer');
            let isDragging = false;

            function updateFromMouse(e) {
                const rect = scrubber.getBoundingClientRect();
                const x = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                state.currentTime = Math.floor(x * CONFIG.times);
                updateTimeDisplay();
                update3DChart();
                updateHIROChart();
            }

            scrubber.addEventListener('mousedown', (e) => {
                isDragging = true;
                updateFromMouse(e);
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) updateFromMouse(e);
            });

            document.addEventListener('mouseup', () => isDragging = false);

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case ' ':
                        e.preventDefault();
                        togglePlayback();
                        break;
                    case 'ArrowLeft':
                        state.currentTime = Math.max(0, state.currentTime - 1);
                        updateTimeDisplay();
                        update3DChart();
                        updateHIROChart();
                        break;
                    case 'ArrowRight':
                        state.currentTime = Math.min(CONFIG.times - 1, state.currentTime + 1);
                        updateTimeDisplay();
                        update3DChart();
                        updateHIROChart();
                        break;
                    case '1': setLens('gamma'); break;
                    case '2': setLens('delta'); break;
                    case '3': setLens('charm'); break;
                }
            });
        }

        function setLens(lens) {
            document.querySelectorAll('.lens-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lens === lens);
            });
            state.currentLens = lens;
            update3DChart();
            updateInterpretation();
        }

        // =====================================================
        // Initialize
        // =====================================================

        function init() {
            initCharts();
            initEventHandlers();
            updateTimeDisplay();

            // Simulate data updates
            setInterval(() => {
                // Update stability gauge
                const stability = 60 + Math.random() * 30;
                document.getElementById('stabilityFill').style.width = stability + '%';
                document.getElementById('stabilityValue').textContent = Math.round(stability) + '%';
                
                const color = stability > 70 ? 'var(--positive)' : stability > 40 ? 'var(--neutral)' : 'var(--negative)';
                document.getElementById('stabilityFill').style.background = color;
                document.getElementById('stabilityValue').style.color = color;
            }, 5000);

            // Hide loading
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
            }, 1200);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>